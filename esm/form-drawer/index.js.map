{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["form-drawer/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { Fragment, useLayoutEffect, useRef, useState } from 'react'\nimport { createPortal } from 'react-dom'\nimport {\n  createForm,\n  IFormProps,\n  Form,\n  onFormSubmitSuccess,\n} from '@formily/core'\nimport { toJS } from '@formily/reactive'\nimport { FormProvider, observer } from '@formily/react'\nimport {\n  isNum,\n  isStr,\n  isBool,\n  isFn,\n  IMiddleware,\n  applyMiddleware,\n} from '@formily/shared'\nimport { Drawer } from '@arco-design/web-react'\nimport { DrawerProps } from '@arco-design/web-react/es/Drawer'\nimport {\n  createPortalProvider,\n  createPortalRoot,\n  loading,\n} from '../__builtins__'\n\nfunction isPromise(obj) {\n  return (\n    !!obj && //有实际含义的变量才执行方法，变量null，undefined和''空串都为false\n    (typeof obj === 'object' || typeof obj === 'function') && // 初始promise 或 promise.then返回的\n    typeof obj.then === 'function'\n  )\n}\ntype FormDrawerRenderer =\n  | React.ReactElement\n  | ((form: Form) => React.ReactElement)\n\ntype Title = string | number | React.ReactElement\n\nconst isTitleComp = (props: any): props is Title =>\n  isNum(props) || isStr(props) || isBool(props) || React.isValidElement(props)\n\nconst getDrawerProps = (props: any): IDrawerProps => {\n  if (isTitleComp(props)) {\n    return {\n      title: props,\n    }\n  } else {\n    return props\n  }\n}\nexport interface IFormDrawer {\n  open(props?: IFormProps): Promise<any>\n  forOpen(middleware: IMiddleware<IFormProps>): IFormDrawer\n  close(): void\n}\nexport interface IDrawerProps extends Omit<DrawerProps, 'onCancel'> {\n  loadingText?: React.ReactNode\n  onCancel?: (e: any) => void | Promise<any> | boolean\n}\nexport function FormDrawer(\n  title: IDrawerProps,\n  id: string,\n  renderer: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: IDrawerProps,\n  id: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(\n  title: Title,\n  id: string,\n  renderer: FormDrawerRenderer\n): IFormDrawer\nexport function FormDrawer(title: Title, id: FormDrawerRenderer): IFormDrawer\n\n/**\n * 渲染一个弹窗\n * @param title\n * @param id\n * @param renderer\n * @returns\n */\nexport function FormDrawer(title: any, id: any, renderer?: any): IFormDrawer {\n  if (isFn(id) || React.isValidElement(id)) {\n    renderer = id\n    id = 'form-drawer'\n  }\n  const env: {\n    host: HTMLElement\n    form: Form | null\n    promise: Promise<any> | null\n    openMiddlewares: IMiddleware<IFormProps>[]\n  } = {\n    host: document.createElement('div'),\n    form: null,\n    promise: null,\n    openMiddlewares: [],\n  }\n  const root = createPortalRoot(env.host, id)\n  const props = getDrawerProps(title)\n  const drawer: IDrawerProps = {\n    width: '40%',\n    ...props,\n    onCancel: (e: any) => {\n      if (props?.onCancel?.(e) !== false) {\n        formDrawer.close()\n      }\n    },\n    afterClose() {\n      props?.afterClose?.()\n      root.unmount()\n    },\n  }\n\n  const DrawerContent = observer(() => (\n    <Fragment>{isFn(renderer) ? renderer(env.form) : renderer}</Fragment>\n  ))\n\n  const renderDrawer = (visible = true) => (\n    <Drawer footer={null} {...drawer} visible={visible}>\n      {env.form ? (\n        <FormProvider form={env.form}>\n          <DrawerContent />\n        </FormProvider>\n      ) : null}\n    </Drawer>\n  )\n\n  document.body.appendChild(env.host)\n  const formDrawer = {\n    forOpen: (middleware: IMiddleware<IFormProps>) => {\n      if (isFn(middleware)) {\n        env.openMiddlewares.push(middleware)\n      }\n      return formDrawer\n    },\n    open: async (drawerProps: IFormProps) => {\n      if (env.promise) {\n        return env.promise\n      }\n      env.promise = new Promise<object>(async (resolve, reject) => {\n        drawerProps = await loading(drawer.loadingText, () =>\n          applyMiddleware(drawerProps, env.openMiddlewares)\n        )\n        try {\n          env.form =\n            env.form ||\n            createForm({\n              ...drawerProps,\n              effects(form) {\n                onFormSubmitSuccess(() => {\n                  resolve(toJS<object>(form.values))\n                  formDrawer.close()\n                })\n                drawerProps?.effects?.(form)\n              },\n            })\n        } catch (e) {\n          reject(e)\n        }\n        root.render(() => renderDrawer(false))\n        setTimeout(() => {\n          root.render(() => renderDrawer(true))\n        }, 16)\n      })\n      return env.promise\n    },\n    close: () => {\n      if (!env.host) {\n        return\n      }\n      root.render(() => renderDrawer(false))\n    },\n  }\n  return formDrawer\n}\n\nconst DrawerFooter: React.FC = (props) => {\n  const ref = useRef<HTMLDivElement>(null)\n  const [footer, setFooter] = useState<HTMLDivElement>()\n  const footerRef = useRef<HTMLDivElement>()\n  const prefixCls = 'arco-drawer'\n  useLayoutEffect(() => {\n    const content = ref.current?.closest(`.${prefixCls}-scroll`)\n    if (content) {\n      if (!footerRef.current) {\n        footerRef.current = content.querySelector(\n          `.${prefixCls}-footer`\n        ) as HTMLDivElement\n        if (!footerRef.current) {\n          footerRef.current = document.createElement('div')\n          footerRef.current.classList.add(`${prefixCls}-footer`)\n          content.appendChild(footerRef.current)\n        }\n      }\n      setFooter(footerRef.current)\n    }\n  })\n\n  footerRef.current = footer\n  return (\n    <div ref={ref} style={{ display: 'none' }}>\n      {footer && createPortal(props.children, footer)}\n    </div>\n  )\n}\n\nFormDrawer.Footer = DrawerFooter\n\nFormDrawer.Portal = createPortalProvider('form-drawer')\n\nexport default FormDrawer\n"]}