{"version":3,"file":"index.js","sourceRoot":"lib/","sources":["form-dialog/index.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { Fragment, useRef, useLayoutEffect, useState } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport { createForm, IFormProps, Form } from \"@formily/core\";\nimport { toJS } from \"@formily/reactive\";\nimport { FormProvider, Observer, observer } from \"@formily/react\";\nimport {\n  isNum,\n  isStr,\n  isBool,\n  isFn,\n  applyMiddleware,\n  IMiddleware,\n} from \"@formily/shared\";\nimport { Modal } from \"@arco-design/web-react\";\nimport type { ModalProps } from \"@arco-design/web-react/es/modal/interface\";\nimport {\n  usePrefixCls,\n  loading,\n  createPortalProvider,\n  createPortalRoot,\n} from \"../__builtins__\";\n\ntype FormDialogRenderer =\n  | React.ReactElement\n  | ((form: Form) => React.ReactElement);\n\ntype ModalTitle = string | number | React.ReactElement;\n\nconst isModalTitle = (props: any): props is ModalTitle =>\n  isNum(props) || isStr(props) || isBool(props) || React.isValidElement(props);\n\nconst getModelProps = (props: any): IModalProps => {\n  if (isModalTitle(props)) {\n    return {\n      title: props,\n    };\n  } else {\n    return props;\n  }\n};\n\nexport interface IFormDialog {\n  forOpen(middleware: IMiddleware<IFormProps>): IFormDialog;\n  forConfirm(middleware: IMiddleware<Form>): IFormDialog;\n  forCancel(middleware: IMiddleware<Form>): IFormDialog;\n  open(props?: IFormProps): Promise<any>;\n  close(): void;\n}\n\nexport interface IModalProps\n  extends Omit<ModalProps, \"onOk\" | \"onCancel\"> {\n  getModalProps?: (\n    props: IModalProps & {\n      triggerConfirm?: () => any;\n      triggerCancel?: () => any;\n    }\n  ) => IModalProps;\n  onOk?: (e: any) => void | Promise<any> | boolean;\n  onCancel?: () => void | Promise<any> | boolean;\n  loadingText?: React.ReactNode;\n}\n\nexport function FormDialog(\n  title: IModalProps,\n  id: string,\n  renderer: FormDialogRenderer\n): IFormDialog;\nexport function FormDialog(\n  title: IModalProps,\n  renderer: FormDialogRenderer\n): IFormDialog;\nexport function FormDialog(\n  title: ModalTitle,\n  id: string,\n  renderer: FormDialogRenderer\n): IFormDialog;\nexport function FormDialog(\n  title: ModalTitle,\n  renderer: FormDialogRenderer\n): IFormDialog;\nexport function FormDialog(title: any, id: any, renderer?: any): IFormDialog {\n  if (isFn(id) || React.isValidElement(id)) {\n    renderer = id;\n    id = \"form-dialog\";\n  }\n  const env: {\n    host: HTMLElement;\n    form: Form | null;\n    promise: Promise<any> | null;\n    openMiddlewares: IMiddleware<IFormProps>[];\n    confirmMiddlewares: IMiddleware<Form>[];\n    cancelMiddlewares: IMiddleware<Form>[];\n  } = {\n    host: document.createElement(\"div\"),\n    form: null,\n    promise: null,\n    openMiddlewares: [],\n    confirmMiddlewares: [],\n    cancelMiddlewares: [],\n  };\n  const root = createPortalRoot(env.host, id);\n  const props = getModelProps(title);\n  const modal = {\n    ...props,\n    afterClose: () => {\n      props?.afterClose?.();\n      root.unmount();\n    },\n  };\n  const DialogContent = observer(() => (\n    <Fragment>{isFn(renderer) ? renderer(env.form) : renderer}</Fragment>\n  ));\n  const renderDialog = (\n    visible = true,\n    resolve?: () => any,\n    reject?: () => any\n  ) => (\n    <Observer>\n      {() => (\n        <Modal\n          {...modal}\n          {...(modal?.getModalProps?.({\n            ...modal,\n            triggerConfirm: resolve,\n            triggerCancel: reject,\n          }) || {})}\n          visible={visible}\n          confirmLoading={env?.form?.submitting}\n          onCancel={() => {\n            if (modal?.onCancel?.() !== false) {\n              reject?.();\n            }\n          }}\n          onOk={async (e) => {\n            if (modal?.onOk?.(e) !== false) {\n              resolve?.();\n            }\n          }}\n          onConfirm={async (e) => {\n            if (modal?.onOk?.(e) !== false) {\n              resolve?.();\n            }\n          }}\n        >\n          {env.form ? (\n            <FormProvider form={env.form}>\n              <DialogContent />\n            </FormProvider>\n          ) : null}\n        </Modal>\n      )}\n    </Observer>\n  );\n\n  document.body.appendChild(env.host);\n  const formDialog = {\n    forOpen: (middleware: IMiddleware<IFormProps>) => {\n      if (isFn(middleware)) {\n        env.openMiddlewares.push(middleware);\n      }\n      return formDialog;\n    },\n    forConfirm: (middleware: IMiddleware<Form>) => {\n      if (isFn(middleware)) {\n        env.confirmMiddlewares.push(middleware);\n      }\n      return formDialog;\n    },\n    forCancel: (middleware: IMiddleware<Form>) => {\n      if (isFn(middleware)) {\n        env.cancelMiddlewares.push(middleware);\n      }\n      return formDialog;\n    },\n    open: async (formProps: IFormProps) => {\n      if (env.promise) {\n        return env.promise;\n      }\n\n      env.promise = new Promise(async (resolve, reject) => {\n        try {\n          formProps = await loading(modal.loadingText, () =>\n            applyMiddleware(formProps, env.openMiddlewares)\n          );\n          env.form = env.form || createForm(formProps);\n        } catch (e) {\n          reject(e);\n        }\n        root.render(() =>\n          renderDialog(\n            true,\n            () => {\n              env.form\n                ?.submit(async () => {\n                  await applyMiddleware(env.form, env.confirmMiddlewares);\n                  resolve(toJS(env.form?.values));\n                  formDialog.close();\n                })\n                .catch(() => {\n                  /** do nothing */\n                });\n            },\n            async () => {\n              await loading(modal.loadingText, () =>\n                applyMiddleware(env.form, env.cancelMiddlewares)\n              );\n              formDialog.close();\n            }\n          )\n        );\n      });\n      return env.promise;\n    },\n    close: () => {\n      if (!env.host) {\n        return;\n      }\n      root.render(() => renderDialog(false));\n    },\n  };\n  return formDialog;\n}\n\nconst DialogFooter: React.FC = (props) => {\n  const ref = useRef<HTMLDivElement>(null);\n  const [footer, setFooter] = useState<HTMLDivElement>();\n  const footerRef = useRef<HTMLDivElement>();\n  const prefixCls = usePrefixCls(\"\", {\n    prefixCls: \"semi-modal\",\n  });\n  useLayoutEffect(() => {\n    const content = ref.current?.closest(`.${prefixCls}-content`);\n    if (content) {\n      if (!footerRef.current) {\n        footerRef.current = content.querySelector(\n          `.${prefixCls}-footer`\n        ) as HTMLDivElement;\n        if (!footerRef.current) {\n          footerRef.current = document.createElement(\"div\");\n          footerRef.current.classList.add(`${prefixCls}-footer`);\n          content.appendChild(footerRef.current);\n        }\n      }\n      setFooter(footerRef.current);\n    }\n  });\n\n  footerRef.current = footer;\n\n  return (\n    <div ref={ref} style={{ display: \"none\" }}>\n      {footer && createPortal(props.children, footer)}\n    </div>\n  );\n};\n\nFormDialog.Footer = DialogFooter;\n\nFormDialog.Portal = createPortalProvider(\"form-dialog\");\n\nexport default FormDialog;\n"]}